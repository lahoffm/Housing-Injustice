<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Map</title>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- leaflet -->
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <link rel="stylesheet" href="leaflet/Leaflet.NavBar.css" />
    <script src="leaflet/leaflet.js"></script>
    <script src="leaflet/Leaflet.NavBar.js"></script>

    <script src="leaflet/leaflet-search.js"></script>
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.css" media="screen,projection"/>
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!--Import jQuery before materialize.js-->
    <!-- <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script> -->
    <script type="text/javascript" src="js/materialize.js"></script>
    <!--created stylesheet for juma -->
    <link type="text/css" rel="stylesheet" href="css/juma_style.css" media="screen,projection"/>

    <link href="searchbox.css" rel="stylesheet" />

    <!--Creates color changing effect for the background of pages -->
    <style>
        html {
            background:#880e4f;
            /*  blues: #3FC884, 3FC7C8, 3F83C8, 3F3FC8, 843FC8, C83FC8 */
            /* orange & greens: #BC9916, 8CBC16, 39BC16, 16BC46, 16BC99, 168CBC */
        }

        #map {
            width: 1400px;
            height: 700px;
            z-index: 1;
            position:relative;
        }


    </style>
</head>
<body >
    <!-- header with logo -->
    <header>
        <div class="navbar-fixed">
            <nav>
                <div class="nav-wrapper white">
                    <a href="#" class="brand-logo black-text">Juma</a>
                    <ul id="nav-mobile" class="right hide-on-med-and-down ">
                        <li><a style=" color: white;font-size:15px;" class='dropdown-button black-text' href='#' data-activates='dropdown1'>Layers</a>
                            <!-- Dropdown Structure -->
                            <ul id='dropdown1' class='dropdown-content '>

                                <li><a id="raceLayer" href="#!">Racial Density</a></li>
                                <li><a id="ecoLayer" href="#!">Income</a></li>
                                <li class="divider"></li>
                                <!--
                                <li><a href="#!"><i class="material-icons">view_module</i>four</a></li>
                                <li><a href="#!"><i class="material-icons">layers</i>five</a></li>
                                -->
                            </ul>
                        </li>
                        <li ><a class="dropdown-button black-text" href="#" data-activates='dropdown2'>Harbour</a>
                            <ul id='dropdown2' class='dropdown-content '>
                                <li><a id="harbourLayer" href="#!">View Harbour</a></li>
                                <li class="divider"></li>
                            </ul>
                        </li>
                        <li ><a class="black-text" href="#">Info</a></li>
                    </ul>
                </div>
            </nav>
        </div>


    </header>
    <br>
    <!--page content-->
    <main>
        <!-- Modal Structure -->
        <div id="modal1" class="modal">
            <div class="modal-content">

                <div class='center-align'><h5>Edit property information</h5></div>
                <form class='login_form z-depth-3' style='background-color: #f1f1f1'><div>
                <label><b>ParcelID</b></label><input type='text' placeholder='parcel ID' name='parID' >
                <label><b>Address</b></label><input type='text' placeholder='address' name='parAddress' >
                <label><b>Owner</b></label><input type='text' placeholder='owner name' name='ownerName' >
                <label>Owner Address 1</label><input type='text' placeholder='owner address line1' name='oAddr1' >
                <label><b>Owner Address 2</b></label><input type='text' placeholder='owner address line2' name='oAddr2' >
                <label><b>Tax Dist</b></label><input type='text' placeholder='tax dist' name='taxDist' >
                <label><b>Total Assessment</b></label><input type='text' placeholder='total assessment' name='totAssess' >
                <label><b>Land Assessment</b></label><input type='text' placeholder='land assessment' name='landAssess' >
                <label><b>Total Appraised</b></label><input type='text' placeholder='total appraised' name='totAppr' >
                <label><b>Name</b></label><input type='text' placeholder='name' name='name' >
                <label><b>Old Name</b></label><input type='text' placeholder='old name' name='oldName' >
                <label><b>Harbour present</b></label><input type='text' placeholder='1 if harbour owns' name='harbPres' >
                <label><b>Harbour past</b></label><input type='text' placeholder='0 if harbour does not own' name='harbPast' >
                <label><b>Lien present</b></label><input type='text' placeholder='lien status' name='lienPres' ></div> </form>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Save</a>
            </div>
        </div>

        <!-- map region -->
        <div class="row">
            <!-- contains property information when property is clicked -->
            <div class="col s12 m12 l12">
                <div class="map-overlay">
                    <h2 id="overlay-header">Click a Harbour property!</h2>
                    <div id="pd">
                        <p></p>
                    </div>
                    <div id="edit_button">

                    </div>
                </div>

                <!-- holds the map -->
                <div class="z-depth-3" id="map" >

                </div>
            </div>
        </div>
        <!-- box is the edit form -->
        <div class="row">
            <div class="col s7">
                <div id="edit_popup">

                </div>
            </div>
        </div>

        <!-- atlanta image -->
        <div class="parallax-container">
            <div class="parallax">
                <img src="http://wallpaperstock.net/atlanta-foggy-sunrise_wallpapers_36097_1920x1080.jpg">
            </div>
        </div>

        <script>
            //initialize parallax image scroll
            $(document).ready(function(){
                (function($){
                    $(function(){
                        $('.parallax').parallax();
                    });
                })(jQuery);
            });

            $(document).ready(function(){
                // the "href" attribute of the modal trigger must specify the modal ID that wants to be triggered
                $('.modal').modal();
            });
        </script>

        <script>


            // initialize the map
            // Atlanta Coordinates 33.74, -84.38
            var map = L.map('map').setView([33.7490, -84.3880], 13);

            // load a tile layer
            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 22,
                minZoom: 10,

            }).addTo(map);
            map.once('focus',function(){
                map.scrollWheelZoom.disable();
            });
            map.on('click',function(){
                if (map.scrollWheelZoom.enabled()) {
                    map.scrollWheelZoom.disable();
                }
                else {
                    map.scrollWheelZoom.enable();
                }
            });

            // Layer Harbour
            var harbour = L.layerGroup();
            var race = L.layerGroup();
            var eco = L.layerGroup();
            var raceFeature, ecoFeature;

            // Choose color for Race
            function getColorRace(d) {
                return d >= 65.9 ? '#993404' :
                    d >= 45.9 ? '#d95f0e' :
                        d >= 28.1 ? '#fe9929' :
                            d >= 14.3 ? '#fed98e' :
                                '#ffffd4';
            }

            // Setting color for race attribute of map
            function raceColor(feature) {
                return {
                    fillColor: getColorRace(feature.properties.aaPercent),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                };
            }


            // Choose color for Economic data
            function getColorEco(d) {
                return d >= 106516 ? '#eff3ff' :
                    d >= 79578 ? '#bdd7e7' :
                        d >= 59904 ? '#6baed6' :
                            d >= 42204 ? '#3182bd' :
                                '#08519c';
            }

            // Setting color for economic attribute of map
            function ecoColor(feature) {
                return {
                    fillColor: getColorEco(feature.properties.medIncome),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                };
            }

            // Highlight every zipcode
            function highlightFeature(e) {
                var layer = e.target;

                layer.setStyle({
                    weight: 5,
                    color: 'yellow',
                    dashArray: '',
                    fillOpacity: 0.7
                });

                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    layer.bringToFront();
                }
            }

            // On Mouseout reset to original for race file
            function raceResetHighlight(e) {
                raceFeature.resetStyle(e.target);
            }

            // On Mouseout reset to original for eco file
            function ecoResetHighlight(e) {
                ecoFeature.resetStyle(e.target);
            }

            // listener that zooms to the zipcode
            function zoomToFeature(e) {
                map.fitBounds(e.target.getBounds());
            }

            // Trigger to call functions on different events for Race
            function raceOnEachFeature(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: raceResetHighlight,
                    click: zoomToFeature
                });
            }

            // Trigger to call functions on different events for Economics
            function ecoOnEachFeature(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: ecoResetHighlight,
                    click: zoomToFeature
                });
            }

            // Loading racial geojson file
            $.getJSON("geojson/racial.geojson", function(data) {
                raceFeature = L.geoJSON(data, {
                    style: raceColor,
                    onEachFeature: raceOnEachFeature
                });
                raceFeature.addTo(race);
            });

            // Loading economic geojson file
            $.getJSON("geojson/race_eco.geojson", function(data) {
                ecoFeature = L.geoJSON(data, {
                    style: ecoColor,
                    onEachFeature: ecoOnEachFeature
                });
                ecoFeature.addTo(eco);
            });

            // load GeoJSON for harbour property information
            $.getJSON("geojson/harbour.geojson", function(data) {
                // custom icon
                var harbourIcon = L.icon({
                    iconUrl: 'images/h4.png',
                    iconSize: [25, 30]
                });
                L.geoJson(data, {
                    pointToLayer: function(feature, latlng) {
                        //return (commented out to stop displayed markers)
                        return L.marker(latlng, {
                            icon: harbourIcon
                        }).addTo(harbour);

                    },
                    onEachFeature: function onEachFeature(feature,layer){
                        layer.on('click', function (e) {
                            //hide the "click a harbour property" sentence
                            $("#overlay-header").html("");
                            $("#pd").html("");
                            $("#edit_button").html("");
                            $("#timelineButton").html("");
                            //turn current json property into string
                            var information = JSON.stringify(e.target.feature.properties,undefined,4);
                            //$('#pd').append("<p style='float: left'>Address: </p>"  + e.target.feature.properties.Address);
                            //objectify string variable
                            var result = JSON.parse(information);
                            //display the key and value for each json pair
                            $.each(result,function(k,val){
                                if (k == "ATLANTA.HOMESTEAD.EXEMPTION.CODE"){
                                    $('#pd').append("Exemption Code: " + val + '<br/>');
                                }
                                else if(k == "FULTON.HOMESTEAD.EXEMPTION.CODE"){
                                    $('#pd').append("Fult Exemption: " + val + '<br/>');
                                }
                                else{
                                    $('#pd').append(k + " : " + val + '<br/>');
                                }

                                }
                            );
                            //add the edit button giving user option to edit
                            $('#edit_button').append(" <a class='btn-floating btn-mini blue' style='float:right' href='#modal1'> <i class='large material-icons'>mode_edit</i> </a>");
                            //add the timeline button for timeline view
                            /*$('#edit_button').append(" <div class='fixed-action-btn horizontal'> " +
                                "<a class='btn-floating btn-mini blue'  href='#modal1'> <i class='mini material-icons'>mode_edit</i> </a>  " +
                                "<ul>  " +
                                "<li><a class='btn-floating yellow darken-1'><i class='material-icons'>note</i></a></li> " +
                                "</ul> </div>");
                            $('#timelineButton').append("<button class='timelinebtn' type='submit'>Timeline View</button>");
                            */
                        });
                    }

                //on marker click, add or edit harbour information
                    //addTo(map).on("click",function(event){
                }).addTo(map);

                // Default Icon
                //L.geoJson(data).addTo(map);
            });

            $.getJSON("geojson/race.geojson", function(data) {
                L.geoJSON(data, {
                    onEachFeature: onEachFeature
                }).addTo(race);
            });
            $.getJSON("geojson/eco.geojson", function(data) {
                L.geoJSON(data, {
                    onEachFeature: onEachFeature
                }).addTo(eco);
            });

            var overlays = {
                "Harbour": harbour,
                "Race": race,
                "Economic": eco
            };

            // Add home, forward & backward button uses Leaflet.NavBar package
            // https://github.com/davidchouse/Leaflet.NavBar
            //L.control.layers(null, overlays).addTo(map);
            // Add legend for Race
            var legend = L.control({
                position: 'bottomright'
            });

            legend.onAdd = function(map) {

                var div = L.DomUtil.create('div', 'info legend'),
                    grades = [0, 14.3, 28.1, 45.9, 65.9, 100],
                    labels = [];

                // loop through our race percent intervals and generate a label with a colored square for each interval
                for (var i = 0; i < grades.length - 1; i++) {
                    div.innerHTML +=
                        '<i style="background:' + getColorRace(grades[i] + 1) + '"></i> ' +
                        grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
                }

                return div;
            };

            legend.addTo(map);



            //create edit box popup
            function edit_box(){
                $('#edit_popup').append("<div class='center-align'><h5>Edit property information</h5></div>" +
                    "<form class='login_form z-depth-3' style='background-color: #f1f1f1'><div>" +
                    "<label><b>ParcelID</b></label><input type='text' placeholder='parcel ID' name='parID' > " +
                    "<label><b>Address</b></label><input type='text' placeholder='address' name='parAddress' >" +
                    "<label><b>Owner</b></label><input type='text' placeholder='owner name' name='ownerName' "  +
                    "<label>Owner Address 1</label><input type='text' placeholder='owner address line1' name='oAddr1' >" +
                    "<label><b>Owner Address 2</b></label><input type='text' placeholder='owner address line2' name='oAddr2' > " +
                    "<label><b>Tax Dist</b></label><input type='text' placeholder='tax dist' name='taxDist' >" +
                    "<label><b>Total Assessment</b></label><input type='text' placeholder='total assessment' name='totAssess' >" +
                    "<label><b>Land Assessment</b></label><input type='text' placeholder='land assessment' name='landAssess' >" +
                    "<label><b>Total Appraised</b></label><input type='text' placeholder='total appraised' name='totAppr' >" +
                    "<label><b>Name</b></label><input type='text' placeholder='name' name='name' >" +
                    "<label><b>Old Name</b></label><input type='text' placeholder='old name' name='oldName' >" +
                    "<label><b>Harbour present</b></label><input type='text' placeholder='1 if harbour owns' name='harbPres' >" +
                    "<label><b>Harbour past</b></label><input type='text' placeholder='0 if harbour does not own' name='harbPast' >" +
                    "<label><b>Lien present</b></label><input type='text' placeholder='lien status' name='lienPres' ></div>" +
                    "<button onSubmit='hide_editBox()' class='login_btn' type='submit'>Submit</button></form>");
            }
            //hide box after submission
            function hide_editBox(){
                $("#edit_popup").hide();
            }
            //turn harbour properties on and off
            $('#harbourLayer').click(function(event){
                    event.preventDefault();
                    //remove layer if on screen
                    if (map.hasLayer(harbour)){
                        map.removeLayer(harbour);
                        //check toggle
                        $('#harb').prop('checked', false);
                        //add layer if not on screen
                    }else{
                        map.addLayer(harbour);
                        //uncheck toggle
                        $('#harb').prop('checked', true);

                    }

                }
            );
            //turn racial density on and off
            $('#raceLayer').click(function(event){
                    event.preventDefault();
                    if (map.hasLayer(race)){
                        map.removeLayer(race);
                        $('#rac').prop('checked', false);
                    }else{
                        map.addLayer(race);
                        //uncheck toggle
                        $('#rac').prop('checked', true);

                    }

                }
            );
            //turn economic densities on and off
            $('#ecoLayer').click(function(event){
                    event.preventDefault();
                    if (map.hasLayer(eco)){
                        map.removeLayer(eco);
                        $('#eco').prop('checked', false);
                    }else{
                        map.addLayer(eco);
                        //uncheck toggle
                        $('#eco').prop('checked', true);
                    }

                }
            );

		var searchboxControl=createSearchboxControl();
        var control = new searchboxControl({});
		control._searchfunctionCallBack = function (searchkeywords)
        {
			for(i=0; i<searchkeywords.length; i++){
				if(searchkeywords.charAt(i)=='\'' || searchkeywords.charAt(i)=='\"'){
					alert("Please re-enter the address without apostrophes and/or quotes");
					return;
				}
			}
            if (!searchkeywords) {
                alert("Please enter an address to search!");
            }
			else{
				var resq=new Array();
				$.ajax({
                    type: "GET",
                    url: 'mapDoc.php',
                    data: { s : searchkeywords },
					async: false,
                    success: function(data)
                    {
			    alert("in");
							try
								{
									resq = JSON.parse(data);
								}
							catch(e)
								{
									alert(data);
								}
		    },
		    error: function(){
			alert("out");    
		    }
                });
				if(resq.length!=0){
					var x=resq[0]['X'];
					var y=resq[0]['Y'];
					var harbourIcon = L.icon({
						iconUrl: 'images/h1.png',
						iconSize: [25, 30]
					});
					L.marker([y,x], {
                        icon: harbourIcon
                    }).addTo(map);
					map.setView([y,x],18);
				}
			}
        };
		map.addControl(control);
		map.zoomControl.setPosition('topleft');
		L.control.navbar().addTo(map);

        </script>
    </main>

    <!-- footer with logo -->
    <footer class="page-footer white">

        <div class="footer-copyright">
            <div class="container center-align ">
                <p style="color: black ">&#9400; DSSG 2017</p>
            </div>
        </div>
    </footer>
</body>
</html>
